---
// Clean subdomain handler - renders content directly without redirects
// Handles: nj.domain.com/ (state) and wayne-nj.domain.com/ (city)
import Layout from '../layouts/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedCities from '../components/RelatedCities.astro';
import RelatedContent from '../components/RelatedContent.astro';
import RegionalStates from '../components/RegionalStates.astro';
import { supabase } from '../lib/supabase';
import { createCitySlug, generateCityNameVariationsForLookup } from '../lib/slug-utils.js';
import { 
  getCityContentVariations,
  getCityStats,
  getCityFacts,
  type CityData
} from '../lib/city-content-variations';
import { getSiteURL, getDomain, getDesignDNA, getKeywordId, getSiteName, useSubdomains, parseSubdomain, getCitySubdomainURL, getStateSubdomainURL } from '../lib/site-config';
import { getStateContentVariations } from '../lib/state-content-variations';
import { loadKeywordVariations } from '../lib/variations/shared/keyword-loader';

export const prerender = false;

const domain = getDomain();
const host = Astro.request.headers.get('host') || '';
const url = new URL(Astro.request.url);
const pathname = url.pathname;

// Only handle subdomain requests if subdomain mode is enabled
if (!useSubdomains()) {
  return Astro.redirect('/404', 404);
}

// Parse subdomain info
const subdomainInfo = parseSubdomain(host);
const subdomainPart = host.split('.')[0];
const isStateSubdomain = subdomainPart.length === 2 && /^[a-z]{2}$/.test(subdomainPart);

// Determine if this is a state or city request
let stateAbbr: string | null = null;
let citySlug: string | null = null;
let isStateRequest = false;
let isCityRequest = false;

// CRITICAL: Only handle subdomain root requests (pathname === '/')
// When Vercel rewrites nj.domain.com/ to /nj/, that path should be handled by [state]/index.astro
// This route should ONLY handle the subdomain root path
if (pathname === '/') {
  if (subdomainInfo) {
    // City subdomain: wayne-nj.domain.com/
    stateAbbr = subdomainInfo.state;
    citySlug = subdomainInfo.city;
    isCityRequest = true;
  } else if (isStateSubdomain) {
    // State subdomain: nj.domain.com/
    stateAbbr = subdomainPart.toLowerCase();
    isStateRequest = true;
  }
} else {
  // Path is not root - let specific routes handle it
  // This allows [state]/index.astro and [state]/[city].astro to handle rewritten paths
  return Astro.redirect('/404', 404);
}

// If we couldn't determine what to render, return 404
if (!stateAbbr || (!isStateRequest && !isCityRequest)) {
  return Astro.redirect('/404', 404);
}

const SITE_URL = getSiteURL();
const DOMAIN = getDomain();
const SITE_NAME = getSiteName();
const keywordId = getKeywordId();
const designDNA = getDesignDNA();

// Load keyword variations
let getH1Variation: any = null;
let getH3Variation: any = null;
let getMetaVariations: any = null;
try {
  const keywordModule = await loadKeywordVariations(keywordId);
  if (keywordModule && typeof keywordModule.getH1Variation === 'function') {
    getH1Variation = keywordModule.getH1Variation;
  }
  if (keywordModule && typeof keywordModule.getH3Variation === 'function') {
    getH3Variation = keywordModule.getH3Variation;
  }
  if (keywordModule && typeof keywordModule.getMetaVariations === 'function') {
    getMetaVariations = keywordModule.getMetaVariations;
  }
} catch (e: any) {
  console.error('Failed to load keyword variations:', e?.message || e);
  getH1Variation = () => ({ h1: 'Free Government Phone' });
  getH3Variation = () => ({ h3: 'Free Government Phone' });
}

// Initialize render data
let renderType: 'state' | 'city' | null = null;
let stateData: any = null;
let cityData: any = null;
let cities: any[] = [];
let seoTitle = '';
let seoDescription = '';
let seoKeywords = '';
let structuredData: any = {};
let variations: any = null;
let canonicalURL = '';
let stateH1 = '';
let cityH1 = '';
let cityName = '';
let stateName = '';
let stateAbbreviation = '';
let population = 0;
let cityFacts: string[] = [];
let relatedCities: any[] = [];
let breadcrumbItems: any[] = [];

// No fallback data - prevents duplicate content across sites
// If Supabase data is not found, return 404

// ===== STATE PAGE DATA =====
if (isStateRequest) {
  renderType = 'state';
  
  if (supabase) {
    try {
      const { data, error } = await supabase
        .from('states')
        .select('*')
        .eq('abbreviation', stateAbbr!.toUpperCase())
        .maybeSingle();
      
      if (!data || error) {
        return Astro.redirect('/404', 404);
      }
      
      stateData = data;
      
      const { data: citiesData } = await supabase
        .from('cities')
        .select('*')
        .eq('state_id', stateData.id)
        .order('population', { ascending: false })
        .limit(20);
      
      cities = citiesData || [];
      
      if (getMetaVariations) {
        try {
          const metaContent = getMetaVariations(SITE_NAME, DOMAIN, 'state', stateData.name);
          seoTitle = metaContent.title;
          seoDescription = metaContent.description;
        } catch (e: any) {
          seoTitle = `Free Government Phone ${stateData.name} | Get FREE Phone Service 2025`;
          seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs.`;
        }
      } else {
        seoTitle = `Free Government Phone ${stateData.name} | Get FREE Phone Service 2025`;
        seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs.`;
      }
      
      structuredData = {
        "@context": "https://schema.org",
        "@type": "State",
        "name": stateData.name,
        "address": {
          "@type": "PostalAddress",
          "addressRegion": stateData.abbreviation,
          "addressCountry": "US"
        }
      };
    } catch (e: any) {
      console.error('Error fetching state data:', e);
      return Astro.redirect('/404', 404);
    }
  } else {
    // No Supabase - return 404
    return Astro.redirect('/404', 404);
  }

  if (!stateData) {
    return Astro.redirect('/404', 404);
  }

  variations = getStateContentVariations(DOMAIN, stateData.name, stateData.abbreviation);
  canonicalURL = getStateSubdomainURL(stateData.abbreviation.toLowerCase());
  breadcrumbItems = [{ label: 'Home', href: '/' }, { label: stateData.name }];
  
  // Generate state-specific H1 - ensure it's always set with proper fallback
  // Use headingIntro from variations which is state-specific and contains keyword
  stateH1 = variations?.headingIntro || `Free Government Phone in ${stateData.name}`;
  
  // Try to enhance with H1 variation if available, but always keep fallback
  if (getH1Variation) {
    try {
      const h1Variation = getH1Variation(DOMAIN, 'state', undefined, stateData.abbreviation);
      if (h1Variation?.h1 && h1Variation.h1.includes(stateData.name)) {
        stateH1 = h1Variation.h1;
      }
    } catch (e: any) {
      // Keep existing stateH1 (already set above)
    }
  }
  
  // Final fallback to ensure stateH1 is never empty
  if (!stateH1 || stateH1.trim() === '') {
    stateH1 = `Free Government Phone in ${stateData.name}`;
  }
  
  // Ensure SEO title includes state name if not already set
  if (!seoTitle || !seoTitle.includes(stateData.name)) {
    if (getMetaVariations) {
      try {
        const metaContent = getMetaVariations(SITE_NAME, DOMAIN, 'state', stateData.name);
        seoTitle = metaContent.title;
        seoDescription = metaContent.description;
      } catch (e: any) {
        seoTitle = `Free Government Phone in ${stateData.name} | Get FREE Phone Service 2025`;
        seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs. Available in all ${stateData.name} cities.`;
      }
    } else {
      seoTitle = `Free Government Phone in ${stateData.name} | Get FREE Phone Service 2025`;
      seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs. Available in all ${stateData.name} cities.`;
    }
  }
}

// ===== CITY PAGE DATA =====
if (isCityRequest && citySlug && stateAbbr) {
  renderType = 'city';
  
  if (!supabase) {
    return Astro.redirect('/404', 404);
  }

  try {
    const { data: stateResult, error: stateError } = await supabase
      .from('states')
      .select('*')
      .eq('abbreviation', stateAbbr.toUpperCase())
      .maybeSingle();
      
    if (stateError || !stateResult) {
      return Astro.redirect('/404', 404);
    }
    
    stateData = stateResult;
    
    const nameVariations = generateCityNameVariationsForLookup(citySlug);
    let cityResult = null;
    
    for (const cityNameVar of nameVariations) {
      const result = await supabase
        .from('cities')
        .select('*')
        .eq('state_id', stateData.id)
        .eq('name', cityNameVar)
        .maybeSingle();
        
      if (result.data) {
        cityResult = result.data;
        break;
      }
    }
    
    if (!cityResult) {
      return Astro.redirect('/404', 404);
    }
    
    cityData = cityResult;
    cityName = cityData.name;
    stateName = stateData.name;
    stateAbbreviation = stateData.abbreviation;
    const cityStats = getCityStats(cityData as CityData);
    population = cityStats.population || cityData.population || 0;
    variations = getCityContentVariations(DOMAIN, cityName, stateAbbreviation, population);
    
    const cityDataForFacts: CityData = {
      id: cityData.id || 0,
      name: cityData.name,
      state_id: stateData.id,
      population: cityData.population,
      stats: cityData.stats
    };
    cityFacts = getCityFacts(cityName, stateName, stateAbbreviation, cityDataForFacts);

    if (getMetaVariations) {
      try {
        const metaResult = getMetaVariations(SITE_NAME, DOMAIN, 'city', cityName, stateName);
        if (metaResult && metaResult.title && metaResult.description) {
          seoTitle = metaResult.title;
          seoDescription = metaResult.description;
        } else {
          seoTitle = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
          seoDescription = `Get free government phone service in ${cityName}, ${stateAbbreviation}. Check eligibility and apply today.`;
        }
      } catch (e: any) {
        seoTitle = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
        seoDescription = `Get free government phone service in ${cityName}, ${stateAbbreviation}. Check eligibility and apply today.`;
      }
    } else {
      seoTitle = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
      seoDescription = `Get free government phone service in ${cityName}, ${stateAbbreviation}. Check eligibility and apply today.`;
    }

    // Generate city-specific H1 - ensure it's always set with proper fallback
    cityH1 = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
    
    // Try to enhance with H1 variation if available
    if (getH1Variation) {
      try {
        const h1Content = getH1Variation(DOMAIN, 'city', cityName, stateAbbreviation);
        if (h1Content?.h1 && h1Content.h1.includes(cityName)) {
          cityH1 = h1Content.h1;
        }
      } catch (e: any) {
        // Keep existing cityH1 (already set above)
      }
    }
    
    // Final fallback to ensure cityH1 is never empty
    if (!cityH1 || cityH1.trim() === '') {
      cityH1 = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
    }

    canonicalURL = getCitySubdomainURL(createCitySlug(cityName), stateAbbreviation.toLowerCase());
    breadcrumbItems = [
      { label: 'Home', href: '/' },
      { label: stateName, href: getStateSubdomainURL(stateAbbreviation.toLowerCase()) },
      { label: cityName, href: canonicalURL }
    ];

    // Fetch related cities
    try {
      const { data: relatedCitiesData } = await supabase
        .from('cities')
        .select('id, name, population')
        .eq('state_id', stateData.id)
        .neq('id', cityData.id)
        .order('population', { ascending: false })
        .limit(9);
      
      if (relatedCitiesData) {
        relatedCities = relatedCitiesData.map(city => ({
          name: city.name,
          state_abbreviation: stateData.abbreviation,
          population: city.population,
          id: city.id
        }));
      }
    } catch (err) {
      console.error('Error fetching related cities:', err);
    }
  } catch (e: any) {
    console.error('Error fetching city data:', e);
    return Astro.redirect('/404', 404);
  }
}

if (!renderType) {
  return Astro.redirect('/404', 404);
}
---

{renderType === 'state' && stateData && (
  <Layout title={seoTitle} description={seoDescription} canonicalURL={canonicalURL}>
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    <main class="min-h-screen bg-gray-50">
      <Breadcrumbs items={breadcrumbItems} />
      <section style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`} class="text-white py-10">
        <div class="container mx-auto px-4">
          <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-gray-900 text-4xl md:text-6xl font-bold mb-6">{stateH1}</h1>
            <p class="text-gray-900 text-xl md:text-2xl mb-8 text-white" set:html={variations.intro} />
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
              <a href="/apply" class="bg-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors inline-block text-center" style={`color: ${designDNA.colors.primary};`}>Check Eligibility</a>
              <a href="/apply" class="border-2 text-white px-8 py-3 rounded-lg font-semibold hover:bg-white transition-colors inline-block text-center" style={`border-color: white;`}>View Programs</a>
            </div>
          </div>
        </div>
      </section>
      {cities.length > 0 && (
        <section class="py-12 bg-gray-50">
          <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
              <h2 class="text-gray-900 text-3xl font-bold text-center mb-8">{variations.headingCities}</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {cities.map((city: any) => (
                  <a href={getCitySubdomainURL(createCitySlug(city.name), stateAbbr!)} class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <h3 class="text-gray-900 font-semibold text-lg mb-2">{city.name}</h3>
                    <p class="text-gray-900 text-sm">{city.population ? `${city.population.toLocaleString()} residents` : 'N/A'}</p>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </section>
      )}
      <RegionalStates currentState={stateData.abbreviation} currentStateName={stateData.name} />
      <RelatedContent currentPage="state" currentState={stateData.abbreviation} />
    </main>
  </Layout>
)}

{renderType === 'city' && cityData && stateData && (
  <Layout title={seoTitle} description={seoDescription} canonicalURL={canonicalURL}>
    <main class="min-h-screen">
      <section class="relative overflow-hidden text-white" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`}>
        <div class="container mx-auto px-4 py-10 md:py-24 relative z-10">
          <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-gray-900 text-4xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight">{cityH1}</h1>
            <p class="text-gray-900 text-xl md:text-2xl mb-8 text-white max-w-3xl mx-auto">
              Access free smartphone and monthly service through the Lifeline & ACP programs.
              <span class="text-gray-900 font-semibold">No credit check, no hidden fees, instant approval.</span>
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
              <a href="/apply" class="btn-accent text-lg px-8 py-4 font-bold shadow-2xl hover:shadow-3xl transform hover:-translate-y-1 transition-all duration-300 inline-block text-center">Verify Eligibility Now</a>
              <a href="/providers" class="btn-primary text-lg px-8 py-4 font-semibold shadow-lg hover:shadow-xl transition-all duration-300 inline-block text-center">View Providers</a>
            </div>
          </div>
        </div>
      </section>
      <Breadcrumbs items={breadcrumbItems} />
      <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
          <div class="lg:col-span-2">
            <article class="prose prose-lg max-w-none">
              <div class="mb-8 text-gray-900">
                <h2 class="text-gray-900 text-3xl font-bold text-[#22223B] mb-4">Access Free Government Phone in {cityName}</h2>
                <p class="text-gray-900 text-lg text-[#6B7280] leading-relaxed" set:html={variations.intro} />
              </div>
              {population > 0 && (
                <div style={`background: linear-gradient(135deg, ${designDNA.colors.primary}15, ${designDNA.colors.secondary}15); border-color: ${designDNA.colors.primary}30;`} class="rounded-lg p-6 mb-8 border">
                  <h3 class="text-gray-900 text-xl font-bold text-[#22223B] mb-4">About {cityName}, {stateAbbreviation}</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start">
                      <svg class="w-5 h-5 text-primary mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                      </svg>
                      <div>
                        <p class="text-gray-900 font-semibold text-[#22223B]">Population</p>
                        <p class="text-gray-900 text-[#6B7280] text-sm">{population.toLocaleString()} residents</p>
                      </div>
                    </div>
                    <div class="flex items-start">
                      <svg class="w-5 h-5 text-primary mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                      </svg>
                      <div>
                        <p class="text-gray-900 font-semibold text-[#22223B]">Location</p>
                        <p class="text-gray-900 text-[#6B7280] text-sm">{cityName}, {stateAbbreviation}</p>
                      </div>
                    </div>
                  </div>
                  {cityFacts.length > 0 && (
                    <div style={`border-color: ${designDNA.colors.primary}40;`} class="mt-4 pt-4 border-t">
                      <ul class="space-y-2 text-[#6B7280] text-sm">
                        {cityFacts.map((fact) => (
                          <li class="text-gray-900 flex items-start">
                            <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span set:html={fact} />
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}
            </article>
          </div>
        </div>
      </div>
      <RelatedCities cities={relatedCities} stateName={stateName} stateAbbreviation={stateAbbreviation} currentCityName={cityName} maxCities={6} />
      <RelatedContent city={cityName} state={stateName} />
    </main>
  </Layout>
)}
