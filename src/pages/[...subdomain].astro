---
// Subdomain handler for city pages
// Handles requests like: wayne-mi.free-government-phone.org/
import Layout from '../layouts/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedCities from '../components/RelatedCities.astro';
import SimilarCities from '../components/SimilarCities.astro';
import RelatedContent from '../components/RelatedContent.astro';
import { supabase } from '../lib/supabase';
import { createCitySlug, slugToCityName, generateCityNameVariationsForLookup } from '../lib/slug-utils.js';
import { 
  getCityContentVariations,
  getCityStats,
  getCityFacts,
  type CityData,
  type StateData
} from '../lib/city-content-variations';
import { getSiteURL, getDomain, getDesignDNA, getKeywordId, getSiteName, useSubdomains, parseSubdomain, getCitySubdomainURL } from '../lib/site-config';
import { loadKeywordVariations } from '../lib/variations/shared/keyword-loader';

export const prerender = false;

// Only handle subdomain requests if subdomain mode is enabled
const domain = getDomain();
const host = Astro.request.headers.get('host') || '';
const subdomainInfo = parseSubdomain(host);
const subdomainPart = host.split('.')[0];

// Check if it's a state subdomain (2-letter abbreviation, e.g., "nj")
const isStateSubdomain = subdomainPart.length === 2 && /^[a-z]{2}$/.test(subdomainPart);

// If not a subdomain request or subdomain mode disabled, return 404
if (!useSubdomains()) {
  return Astro.redirect('/404', 404);
}

// If it's a state subdomain, let it pass through to [state]/index.astro via Vercel rewrite
if (isStateSubdomain && !subdomainInfo) {
  return; // Let Vercel rewrite handle it
}

// If it's not a valid city subdomain, return 404
if (!subdomainInfo) {
  return Astro.redirect('/404', 404);
}

// Vercel rewrites subdomains to paths like /nj/wayne/, so we should allow those paths
// Only redirect if it's an unexpected path that doesn't match the rewrite pattern
const url = new URL(Astro.request.url);
const isRewrittenPath = url.pathname.match(/^\/([a-z]{2})\/?$/) || url.pathname.match(/^\/([a-z]{2})\/([a-z0-9-]+)\/?$/);
if (!isRewrittenPath && url.pathname !== '/') {
  return Astro.redirect(`https://${host}/`, 301);
}

const { city: citySlug, state: stateAbbr } = subdomainInfo;

// Get Design DNA for dynamic colors
const designDNA = getDesignDNA();

const SITE_URL = getSiteURL();
const DOMAIN = getDomain();
const SITE_NAME = getSiteName();
const keywordId = getKeywordId();

// Load keyword-specific variations for city pages with error handling
let getH1Variation: any = null;
let getH3Variation: any = null;
let getMetaVariations: any = null;
try {
  const keywordModule = await loadKeywordVariations(keywordId);
  if (keywordModule && typeof keywordModule.getH1Variation === 'function') {
    getH1Variation = keywordModule.getH1Variation;
  }
  if (keywordModule && typeof keywordModule.getH3Variation === 'function') {
    getH3Variation = keywordModule.getH3Variation;
  }
  if (keywordModule && typeof keywordModule.getMetaVariations === 'function') {
    getMetaVariations = keywordModule.getMetaVariations;
  }
} catch (e: any) {
  console.error('Failed to load keyword variations for city page:', e?.message || e);
  getH1Variation = () => ({ h1: 'Free Government Phone' });
  getH3Variation = () => ({ h3: 'Free Government Phone' });
}

// Fetch city data from Supabase
let cityData = null;
let stateData = null;
let error = null;

// Check if Supabase is available
if (!supabase) {
  console.error('Supabase client not available - missing environment variables');
  error = 'Database not configured';
} else {
  try {
    // Get state data
    const { data: stateResult, error: stateError } = await supabase
      .from('states')
      .select('*')
      .eq('abbreviation', stateAbbr.toUpperCase())
      .maybeSingle();
      
    if (stateError) {
      console.error('State lookup error:', stateError);
      error = 'State not found';
    } else if (!stateResult) {
      error = 'State not found';
    } else {
      stateData = stateResult;
    }
    
    // Get city data
    if (stateData && !error) {
      // Generate all possible city name variations
      const nameVariations = generateCityNameVariationsForLookup(citySlug);
      let cityResult = null;
      let cityError = null;
      
      // Try each variation until we find a match
      for (const cityName of nameVariations) {
        const result = await supabase
          .from('cities')
          .select('*')
          .eq('state_id', stateData.id)
          .eq('name', cityName)
          .maybeSingle();
          
        if (result.error) {
          cityError = result.error;
          continue;
        }
        
        if (result.data) {
          cityResult = result.data;
          break;
        }
      }
      
      if (cityError) {
        console.error('City lookup error:', cityError);
        error = 'City lookup failed';
      } else if (!cityResult) {
        error = 'City not found';
      } else {
        cityData = cityResult;
      }
    }
  } catch (e: any) {
    console.error('Error fetching city data:', e);
    error = 'Database error';
  }
}

// If we couldn't find the city, return 404
if (error || !cityData || !stateData) {
  return Astro.redirect('/404', 404);
}

const cityName = cityData.name;
const stateName = stateData.name;
const stateAbbreviation = stateData.abbreviation;

// Get city statistics
const cityStats = getCityStats(cityData as CityData);
const population = cityStats.population || cityData.population || 0;

// Get COMPOUND-HASH content variations for 99-100% uniqueness across 1000+ sites
const variations = getCityContentVariations(
  DOMAIN,
  cityName,
  stateAbbreviation,
  population
);

// Get city facts
const cityDataForFacts: CityData = {
  id: cityData.id || 0,
  name: cityData.name,
  state_id: stateData.id,
  population: cityData.population,
  stats: cityData.stats
};
const cityFacts = getCityFacts(cityName, stateName, stateAbbreviation, cityDataForFacts);

// Fetch related cities from same state
let relatedCities: Array<{
  name: string;
  state_abbreviation: string;
  population?: number;
  id?: number;
}> = [];

if (cityData && stateData && supabase && !error) {
  try {
    const { data: relatedCitiesData } = await supabase
      .from('cities')
      .select('id, name, population')
      .eq('state_id', stateData.id)
      .neq('id', cityData.id)
      .order('population', { ascending: false })
      .limit(9);
    
    if (relatedCitiesData) {
      relatedCities = relatedCitiesData.map(city => ({
        name: city.name,
        state_abbreviation: stateData.abbreviation,
        population: city.population,
        id: city.id
      }));
    }
  } catch (err) {
    console.error('Error fetching related cities:', err);
  }
}

// Fetch similar cities from OTHER states (by similar population)
let similarCities: Array<{
  name: string;
  state_abbr: string;
  state_name: string;
  population?: number;
}> = [];

if (cityData && stateData && supabase && !error) {
  try {
    const pop = cityData.population || 50000;
    const minPop = Math.max(1000, pop * 0.5);
    const maxPop = pop * 2;
    
    const { data: similarData } = await supabase
      .from('cities')
      .select('name, population, state_id, states(abbreviation, name)')
      .neq('state_id', stateData.id)
      .gte('population', minPop)
      .lte('population', maxPop)
      .order('population', { ascending: false })
      .limit(12);
    
    if (similarData) {
      similarCities = similarData.map((city: any) => ({
        name: city.name,
        state_abbr: city.states?.abbreviation || '',
        state_name: city.states?.name || '',
        population: city.population
      })).filter((c: any) => c.state_abbr);
    }
  } catch (err) {
    console.error('Error fetching similar cities:', err);
  }
}

// Get meta content
let metaContent = { 
  title: `Free Government Phone in ${cityName}, ${stateAbbreviation}`, 
  description: `Get free government phone service in ${cityName}, ${stateAbbreviation}. Check eligibility and apply today.` 
};

if (getMetaVariations) {
  try {
    const metaResult = getMetaVariations(SITE_NAME, DOMAIN, 'city', cityName, stateName);
    if (metaResult && metaResult.title && metaResult.description) {
      metaContent = metaResult;
    }
  } catch (metaError: any) {
    console.error('Error getting meta variations for city page:', metaError?.message || metaError);
  }
}

// Get dynamic H1 variation for city page
let cityH1 = `Free Government Phone in ${cityName}, ${stateAbbreviation}`;
if (getH1Variation) {
  try {
    const h1Content = getH1Variation(DOMAIN, 'city', cityName, stateAbbreviation);
    cityH1 = h1Content.h1;
  } catch (h1Error: any) {
    console.error('Error getting H1 variation for city page:', h1Error?.message || h1Error);
  }
}

const title = metaContent.title;
const description = metaContent.description;

// Generate canonical URL using subdomain format
const canonicalUrl = getCitySubdomainURL(createCitySlug(cityName), stateAbbreviation.toLowerCase());

// Enhanced structured data with city-specific information
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": `Free Government Phone in ${cityName}, ${stateAbbreviation}`,
  "description": description,
  "url": canonicalUrl,
  "mainEntity": {
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": `Who qualifies for free government phone service in ${cityName}?`,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": `Residents of ${cityName}, ${stateAbbreviation} may qualify for free government phone service if they participate in qualifying government assistance programs or meet income requirements.`
        }
      }
    ]
  }
};

const citySchema = {
  "@context": "https://schema.org",
  "@type": "City",
  "name": cityName,
  "containedIn": {
    "@type": "State",
    "name": stateName,
    "abbreviation": stateAbbreviation
  }
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": SITE_URL
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": stateName,
      "item": `${SITE_URL}/${stateAbbreviation.toLowerCase()}/`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": cityName,
      "item": canonicalUrl
    }
  ]
};

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: stateName, href: `/${stateAbbreviation.toLowerCase()}/` },
  { label: cityName, href: canonicalUrl }
];

---

<Layout title={title} description={description} canonicalURL={canonicalUrl}>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  <script type="application/ld+json" set:html={JSON.stringify(citySchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <!-- Hero Section - Uses Design DNA colors -->
  <section class="relative overflow-hidden text-white" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`}>
    <div class="container mx-auto px-4 py-10 md:py-24 relative z-10">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-gray-900 text-4xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight">
          {cityH1}
        </h1>
        <p class="text-gray-900 text-xl md:text-2xl mb-8 text-white max-w-3xl mx-auto">
          Access free smartphone and monthly service through the Lifeline & ACP programs. 
          <span class="text-gray-900 font-semibold ">No credit check, no hidden fees, instant approval.</span>
        </p>
        
        <!-- CTA Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
          <a href="/apply" class="btn-accent text-lg px-8 py-4 font-bold shadow-2xl hover:shadow-3xl transform hover:-translate-y-1 transition-all duration-300 inline-block text-center">
            Verify Eligibility Now
          </a>
          <a href="/providers" class="btn-primary text-lg px-8 py-4 font-semibold shadow-lg hover:shadow-xl transition-all duration-300 inline-block text-center">
            View Providers
          </a>
        </div>
        
        <!-- Trust Badges -->
        <div class="flex flex-wrap justify-center items-center gap-6 opacity-90">
          <div class="trust-badge">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" style={`color: ${designDNA.colors.accent};`} fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-900 text-sm font-medium">FCC Approved</span>
            </div>
          </div>
          <div class="trust-badge">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" style={`color: ${designDNA.colors.accent};`} fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-gray-900 text-sm font-medium">No Credit Check</span>
            </div>
          </div>
          <div class="trust-badge">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" style={`color: ${designDNA.colors.accent};`} fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span class="text-gray-900 text-sm font-medium">Instant Approval</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Breadcrumbs with Schema -->
  <Breadcrumbs items={breadcrumbItems} />

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
      <!-- Main Article Content -->
      <div class="lg:col-span-2">
        <article class="prose prose-lg max-w-none">
          <!-- Introduction - Domain-based unique content -->
          <div class="mb-8 text-gray-900">
            <h2 class="text-gray-900 text-3xl font-bold text-[#22223B] mb-4 ">
              Access Free Government Phone in {cityName}
            </h2>
            <p class="text-gray-900 text-lg text-[#6B7280] leading-relaxed" set:html={variations.intro} />
          </div>

          <!-- City Information Section -->
          {population && (
            <div style={`background: linear-gradient(135deg, ${designDNA.colors.primary}15, ${designDNA.colors.secondary}15); border-color: ${designDNA.colors.primary}30;`} class="rounded-lg p-6 mb-8 border">
              <h3 class="text-gray-900 text-xl font-bold text-[#22223B] mb-4 ">About {cityName}, {stateAbbreviation}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {population && (
                  <div class="flex items-start">
                    <svg class="w-5 h-5 text-primary mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    <div>
                      <p class="text-gray-900 font-semibold text-[#22223B]">Population</p>
                      <p class="text-gray-900 text-[#6B7280] text-sm">{population.toLocaleString()} residents</p>
                    </div>
                  </div>
                )}
                <div class="flex items-start">
                  <svg class="w-5 h-5 text-primary mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <p class="text-gray-900 font-semibold text-[#22223B]">Location</p>
                    <p class="text-gray-900 text-[#6B7280] text-sm">{cityName}, {stateAbbreviation}</p>
                  </div>
                </div>
              </div>
              {cityFacts.length > 0 && (
                <div style={`border-color: ${designDNA.colors.primary}40;`} class="mt-4 pt-4 border-t">
                  <ul class="space-y-2 text-[#6B7280] text-sm">
                    {cityFacts.map((fact) => (
                      <li class="text-gray-900 flex items-start">
                        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span set:html={fact} />
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </article>
      </div>
    </div>
  </div>

  <!-- Related Cities -->
  <RelatedCities 
    cities={relatedCities}
    stateName={stateName}
    stateAbbreviation={stateAbbreviation}
    currentCityName={cityName}
    maxCities={6}
  />

  <!-- Similar Cities -->
  <SimilarCities 
    currentCityName={cityName}
    currentStateAbbr={stateAbbreviation}
    currentPopulation={population}
    similarCities={similarCities}
  />

  <!-- Related Content -->
  <RelatedContent 
    city={cityName}
    state={stateName}
  />
</Layout>

