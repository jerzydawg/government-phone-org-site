---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import AboveFoldCTA from '../../components/AboveFoldCTA.astro';
import { supabase, createClient } from "../../lib/supabase";
import { createCitySlug } from '../../lib/slug-utils.js';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import RegionalStates from '../../components/RegionalStates.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import { getSiteURL, getDomain, getKeywordId, getSiteName, getDesignDNA, useSubdomains, getStateSubdomainURL, parseSubdomain } from '../../lib/site-config';
import { getStateContentVariations } from '../../lib/state-content-variations';
import { loadKeywordVariations } from '../../lib/variations/shared/keyword-loader';

const SITE_URL = getSiteURL();
const DOMAIN = getDomain();
const SITE_NAME = getSiteName();
const keywordId = getKeywordId(); // Already has fallback in getKeywordId() function
const designDNA = getDesignDNA();

// SECURITY: Block incorrect routing patterns when subdomain mode is enabled
if (useSubdomains()) {
  const hostname = Astro.request.headers.get('host') || '';
  const subdomainInfo = parseSubdomain(hostname);

  if (!subdomainInfo) {
    // Direct path access without subdomain - block it
    return Astro.redirect('/404', 404);
  }
}

// Load keyword-specific variations for state pages with error handling
let getH3Variation: any = null;
let getMetaVariations: any = null;
try {
  const keywordModule = await loadKeywordVariations(keywordId);
  if (keywordModule && typeof keywordModule.getH3Variation === 'function') {
    getH3Variation = keywordModule.getH3Variation;
  }
  if (keywordModule && typeof keywordModule.getMetaVariations === 'function') {
    getMetaVariations = keywordModule.getMetaVariations;
  }
} catch (e: any) {
  console.error('Failed to load keyword variations for state page:', e?.message || e);
  // Fallback: create a simple H3 function
  getH3Variation = () => ({ h3: 'Free Government Phone' });
}

// Get state from URL params
const { state } = Astro.params;
const stateUpper = state?.toUpperCase();

// Validate required params
if (!state) {
  return Astro.redirect('/404');
}

// Initialize variables
let stateData: any = null;
let cities: any[] = [];
let seoTitle = '';
let seoDescription = '';
let seoKeywords = '';
let structuredData = {};

// Initialize Supabase client with error handling
try {
  // Check if Supabase is available
  if (!supabase) {
    return Astro.redirect('/404');
  }

  // Query 1: Get state data
  const { data: stateResult, error: stateError } = await supabase
    .from('states')
    .select('id, name, abbreviation, region')
    .eq('abbreviation', stateUpper)
    .maybeSingle();

  if (stateError || !stateResult) {
    if (stateError) {
      console.error('Supabase error fetching state data:', stateError);
    }
    return Astro.redirect('/404');
  }

  stateData = stateResult;

  // Query 2: Get cities for this state (parallel-safe, runs after state is found)
  const { data: citiesData, error: citiesError } = await supabase
    .from('cities')
    .select('id, name, population, county')
    .eq('state_id', stateData.id)
    .order('population', { ascending: false })
    .limit(25);

  if (!citiesError && citiesData) {
    // Known incorrect mappings to filter out
    const incorrectMappings: Record<string, string[]> = {
      'GA': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth', 'Arlington', 'Plano', 'Lubbock', 'Laredo', 'Amarillo'],
      'TX': ['Atlanta', 'Augusta', 'Columbus', 'Macon', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Albany'],
      'CA': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Atlanta', 'Augusta', 'Columbus'],
      'NY': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Atlanta', 'Augusta', 'Columbus'],
      'FL': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Atlanta', 'Augusta', 'Columbus']
    };

    const incorrectCitiesForState = incorrectMappings[stateData.abbreviation] || [];
    cities = citiesData
      .filter((city: any) => !incorrectCitiesForState.includes(city.name))
      .slice(0, 20);
  }

  // Generate SEO content using keyword variations
  if (getMetaVariations) {
    try {
      const metaContent = getMetaVariations(SITE_NAME, DOMAIN, 'state', stateData.name);
      seoTitle = metaContent.title;
      seoDescription = metaContent.description;
    } catch (metaError: any) {
      console.error('Error getting meta variations for state page:', metaError?.message || metaError);
      seoTitle = `Free Government Phone ${stateData.name} | Access FREE Government Phone Service 2025`;
      seoDescription = `Access federal communication assistance programs in ${stateData.name}. Apply for ACP, Lifeline, and other federal programs. Available in all ${stateData.name} cities. No cost to eligible residents.`;
    }
  } else {
    seoTitle = `Free Government Phone ${stateData.name} | Access FREE Government Phone Service 2025`;
    seoDescription = `Access federal communication assistance programs in ${stateData.name}. Apply for ACP, Lifeline, and other federal programs. Available in all ${stateData.name} cities. No cost to eligible residents.`;
  }
  seoKeywords = `federal communication assistance ${stateData.name}, ${stateData.name} federal communication, free communication ${stateData.name}, ACP ${stateData.name}, Lifeline ${stateData.name}`;

  // Generate structured data
  structuredData = {
    "@context": "https://schema.org",
    "@type": "State",
    "name": stateData.name,
    "address": {
      "@type": "PostalAddress",
      "addressRegion": stateData.abbreviation,
      "addressCountry": "US"
    },
    "description": `Federal communication assistance programs available in ${stateData.name}`,
    "url": `${SITE_URL}/${stateData.abbreviation.toLowerCase()}/`
  };

} catch (error) {
  console.error('Failed to initialize Supabase client:', error);
  return Astro.redirect('/404');
}

// No fallback data - prevents duplicate content across sites
// If Supabase data is not found, return 404

// If no state data found, redirect to 404
if (!stateData) {
  return Astro.redirect('/404');
}

// Get domain-based content variations for unique content across 1000+ sites
const variations = getStateContentVariations(DOMAIN, stateData.name, stateData.abbreviation);
// Use subdomain URL if subdomain mode is enabled, otherwise use path-based URL
const canonicalURL = useSubdomains() 
  ? getStateSubdomainURL(stateData.abbreviation.toLowerCase())
  : `${SITE_URL}/${stateData.abbreviation.toLowerCase()}/`;

// Generate state-specific H1 - use headingIntro from variations which is state-specific
const stateH1 = variations.headingIntro || `Free Government Phone in ${stateData.name}`;

// Ensure SEO title includes state name if not already set properly
if (!seoTitle || !seoTitle.includes(stateData.name)) {
  if (getMetaVariations) {
    try {
      const metaContent = getMetaVariations(SITE_NAME, DOMAIN, 'state', stateData.name);
      seoTitle = metaContent.title;
      seoDescription = metaContent.description;
    } catch (metaError: any) {
      seoTitle = `Free Government Phone in ${stateData.name} | Get FREE Phone Service 2025`;
      seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs. Available in all ${stateData.name} cities.`;
    }
  } else {
    seoTitle = `Free Government Phone in ${stateData.name} | Get FREE Phone Service 2025`;
    seoDescription = `Get your FREE Government Phone in ${stateData.name}. Apply for ACP, Lifeline, and other government programs. Available in all ${stateData.name} cities.`;
  }
}
---

<Layout
  title={seoTitle}
  description={seoDescription}
  keywords={seoKeywords}
  canonicalURL={canonicalURL}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": `${SITE_URL}/`
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": stateData.name,
        "item": `${SITE_URL}/${stateData.abbreviation.toLowerCase()}/`
      }
    ]
  })} />
  
  <!-- Enhanced Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": `How do I get a free government phone in ${stateData?.name || stateUpper}?`,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": `Residents of ${stateData?.name || stateUpper} can qualify for a free government phone by meeting income requirements or participating in federal assistance programs. Apply online for instant approval.`
        }
      },
      {
        "@type": "Question",
        "name": `What programs are available in ${stateData?.name || stateUpper}?`,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": `The Lifeline and Affordable Connectivity Program (ACP) are available in ${stateData?.name || stateUpper}, offering free phone and internet service to eligible residents.`
        }
      },
      {
        "@type": "Question",
        "name": `Can I get free internet in ${stateData?.name || stateUpper}?`,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": `Yes, the ACP program provides free or discounted internet service in ${stateData?.name || stateUpper} for qualifying households.`
        }
      }
    ]
  })} />

  <main class="min-h-screen bg-gray-50">
    <!-- Breadcrumb Navigation -->
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: stateData.name }
    ]} />
    
    <!-- Hero Section - Domain-based unique content -->
    <section style={`background: linear-gradient(135deg, ${designDNA.colors.primary}, ${designDNA.colors.secondary});`} class="text-white py-10">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-gray-900 text-4xl md:text-6xl font-bold mb-6 ">
            {stateH1}
          </h1>
          <p class="text-gray-900 text-xl md:text-2xl mb-8 text-white" set:html={variations.intro} />

          <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
            <a href="/apply" rel="noopener noreferrer" style={`color: ${designDNA.colors.primary};`} class="bg-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors inline-block text-center">
              Check Eligibility
            </a>
            <a href="/apply" rel="noopener noreferrer" style={`border-color: white;`} class="border-2 text-white px-8 py-3 rounded-lg font-semibold hover:bg-white transition-colors inline-block text-center" onmouseover={`this.style.color='${designDNA.colors.primary}';`} onmouseout="this.style.color='white';">
              View Programs
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Programs Section - Domain-based unique content -->
    <section class="py-12 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-gray-900 text-3xl font-bold text-center mb-8 ">Free Government Phone Programs in {stateData.name}</h2>
          <p class="text-gray-900 text-center mb-8 " set:html={variations.programsAvailable} />
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-gray-900 text-2xl font-bold mb-4" style={`color: ${designDNA.colors.primary};`}>{getH3Variation(`${DOMAIN}-${state}`, 'state-program-1').h3}</h3>
              <p class="text-gray-900 mb-4 ">
                Get up to $30/month off your internet bill and a one-time $100 discount on a device.
              </p>
              <a href="/apply" rel="noopener noreferrer" style={`color: ${designDNA.colors.primary};`} class="font-semibold hover:underline">Learn More →</a>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-gray-900 text-2xl font-bold text-green-600 mb-4">{getH3Variation(`${DOMAIN}-${state}`, 'state-program-2').h3}</h3>
              <p class="text-gray-900 mb-4 ">
                Receive a free phone and monthly service discount for eligible low-income households.
              </p>
              <a href="/apply" rel="noopener noreferrer" class="text-green-600 font-semibold hover:underline">Learn More →</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cities Section - Domain-based unique content -->
    {cities.length > 0 && (
      <section class="py-12 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-4xl mx-auto">
            <h2 class="text-gray-900 text-3xl font-bold text-center mb-8 ">{variations.headingCities}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {cities.map((city) => (
                <a 
                  href={`/${state}/${createCitySlug(city.name)}/`}
                  class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow"
                >
                  <h3 class="text-gray-900 font-semibold text-lg mb-2 ">{city.name}</h3>
                  <p class="text-gray-900 text-sm">
                    {city.population ? `${city.population.toLocaleString()} residents` : 'N/A'}
                  </p>
                </a>
              ))}
            </div>
            
            <!-- View All Cities CTA -->
            <div class="text-center mt-8">
              <a 
                href="/all"
                style={`background: ${designDNA.colors.primary};`} class="inline-flex items-center justify-center px-6 py-3 text-white font-semibold rounded-lg transition-colors text-center" onmouseover={`this.style.background='${designDNA.colors.secondary}';`} onmouseout={`this.style.background='${designDNA.colors.primary}';`}
              >
                View All Cities in {stateData.name}
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- CTA Section - Domain-based unique content -->
    <section style={`background: ${designDNA.colors.primary};`} class="py-10 text-white">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-gray-900 text-3xl font-bold mb-6 ">{variations.cta.headline}</h2>
        <p class="text-gray-900 text-xl mb-8 ">{variations.cta.subtext}</p>
        <a href="/apply" rel="noopener noreferrer" style={`color: ${designDNA.colors.primary};`} class="bg-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-gray-100 transition-colors inline-block text-center">
          {variations.cta.button}
        </a>
      </div>
    </section>

    <!-- Regional States Section -->
    <RegionalStates currentState={stateData.abbreviation} currentStateName={stateData.name} />

    <!-- Related Content Section -->
    <RelatedContent currentPage="state" currentState={stateData.abbreviation} />
  </main>
</Layout> 